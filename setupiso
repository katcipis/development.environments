#!/bin/env nash

var year = "2020"
var month = "10"
var date = $year + "." + $month + ".01"
var filename = "archlinux-" +$date+ "-x86_64.iso"

var _, status <= test -f $filename

if $status != "0" {
    echo "Downloading arch linux ISO"
    wget "http://archlinux.c3sl.ufpr.br/iso/" +$date+"/"+$filename
    echo "Done downloading, starting VM setup"
}

echo "Building customized ISO"

var basedir <= pwd | xargs echo -n
var workdir = $basedir + "/.isoworkdir"
var mountdir = "/tmp/mnt"

echo "Setting up"

rm -rf $workdir
rm -rf $mountdir
mkdir -p $mountdir

echo "Done, starting building ISO"

var isopath = $basedir + "/" + $filename
echo "ISO file: "$isopath

mount -t iso9660 -o loop $isopath $mountdir
cp -a $mountdir $workdir
umount $mountdir

echo "Customizing ISO"
chdir($workdir + "/arch/x86_64")
unsquashfs airootfs.sfs

var miseinpace = $workdir + "/arch/x86_64/squashfs-root/home/mise.in.place"

mkdir -p $miseinpace
cp $basedir + "/Makefile" $miseinpace
cp $basedir + "/bootstrap" $miseinpace
cp $basedir + "/pre-bootstrap" $miseinpace
cp -r $basedir + "/hack" $miseinpace
cp -r $basedir + "/tools" $miseinpace

echo "Creating new root FS"
rm airootfs.sfs
mksquashfs squashfs-root airootfs.sfs
rm -r squashfs-root
md5sum airootfs.sfs > airootfs.md5

echo "Baking new ISO"
chdir($workdir)
var iso_label = "ARCH_" + $year + $month
var isofilename = $basedir + "/katcipis-" + $filename

chdir($workdir)

var result <= (
    xorriso
            -as mkisofs
            -iso-level 3
            -full-iso9660-filenames
            -volid $iso_label
            -eltorito-boot "isolinux/isolinux.bin"
            -eltorito-catalog "isolinux/boot.cat"
            -no-emul-boot
            -boot-load-size 4
            -boot-info-table
            -isohybrid-mbr "isolinux/isohdpfx.bin"
            -eltorito-alt-boot
            -e "EFI/archiso/efiboot.img"
            -no-emul-boot
            -isohybrid-gpt-basdat
            -output $isofilename $workdir
)

echo "Done"
